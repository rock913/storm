#streamlit_app.py
import streamlit as st
import requests
import json
from datetime import datetime
import streamlit.components.v1 as components

BASE_API = "http://127.0.0.1:5000/api"

def main():
    st.set_page_config(
        page_title="çŸ¥è¯†é£æš´",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # åˆå§‹åŒ–sessionçŠ¶æ€
    if 'token' not in st.session_state:
        st.session_state.token = None
    if 'active_tab' not in st.session_state:
        st.session_state.active_tab = "login"
    if 'login_error' not in st.session_state:
        st.session_state.login_error = None
    if 'register_error' not in st.session_state:
        st.session_state.register_error = None

    # ä¾§è¾¹æ 
    with st.sidebar:
        st.header("ç”¨æˆ·ç³»ç»Ÿ")
        if st.session_state.token:
            show_user_info()
            show_topic_manager()
        else:
            show_auth_forms()

    # ä¸»å†…å®¹åŒº
    if st.session_state.token:
        show_main_content()
    else:
        st.warning("è¯·å…ˆç™»å½•æˆ–æ³¨å†Œ")

def show_auth_forms():
    """æ˜¾ç¤ºè®¤è¯è¡¨å•"""
    tab1, tab2 = st.tabs(["ç™»å½•", "æ³¨å†Œ"])
    
    # æ ¹æ®active_tabè®¾ç½®é»˜è®¤æ¿€æ´»çš„æ ‡ç­¾
    active_idx = 0 if st.session_state.active_tab == "login" else 1
    
    with tab1:
        with st.form("ç™»å½•è¡¨å•"):
            username = st.text_input("ç”¨æˆ·å")
            password = st.text_input("å¯†ç ", type="password")
            if st.form_submit_button("ç™»å½•", on_click=lambda: setattr(st.session_state, 'active_tab', 'login')):
                handle_login(username, password)
    
    with tab2:
        with st.form("æ³¨å†Œè¡¨å•"):
            new_user = st.text_input("æ–°ç”¨æˆ·å")
            new_pass = st.text_input("æ–°å¯†ç ", type="password")
            if st.form_submit_button("æ³¨å†Œ", on_click=lambda: setattr(st.session_state, 'active_tab', 'register')):
                handle_register(new_user, new_pass)
    
    # ä½¿ç”¨JavaScriptä¿æŒæ ‡ç­¾çŠ¶æ€
    components.html(f"""
    <script>
        document.querySelectorAll('button[kind="header"]')[{active_idx}].click()
    </script>
    """, height=0)

@st.cache_data(ttl=60)  # ç¼“å­˜1åˆ†é’Ÿ
def get_current_user():
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯"""
    if not st.session_state.token:
        return None
    
    try:
        # å‘èµ·å¸¦è®¤è¯çš„APIè¯·æ±‚
        headers = {"x-access-token": st.session_state.token}
        response = requests.get(
            f"{BASE_API}/me",
            headers=headers
        )
        
        if response.status_code == 200:
            return response.json()
            
        # å¤„ç†è¿‡æœŸtokenæƒ…å†µ
        if response.status_code == 401:
            st.error("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•")
            st.session_state.token = None
            st.experimental_rerun()
            
        return None
        
    except requests.exceptions.ConnectionError:
        st.error("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨")
        return None
    except Exception as e:
        st.error(f"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: {str(e)}")
        return None

def show_user_info():
    """æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯"""
    try:
        user_info = get_current_user()
        st.success(f"æ¬¢è¿ï¼Œ{user_info['username']}")
        if st.button("é€€å‡ºç™»å½•"):
            st.session_state.token = None
            st.rerun()
    except:
        st.error("ç™»å½•çŠ¶æ€å¼‚å¸¸")

def show_topic_manager():
    """ä¸»é¢˜ç®¡ç†ä¾§è¾¹æ """
    st.header("ä¸»é¢˜ç®¡ç†")
    
    # æ–°å»ºä¸»é¢˜
    with st.expander("æ–°å»ºç ”ç©¶ä¸»é¢˜", expanded=False):
        with st.form("new_topic_form"):
            name = st.text_input("ä¸»é¢˜åç§°")
            model = st.selectbox("æ¨¡å‹é€‰æ‹©", ["gpt-4", "gpt-3.5"])
            max_steps = st.number_input("æœ€å¤§æ­¥æ•°", value=10)
            
            if st.form_submit_button("åˆ›å»ºä¸»é¢˜"):
                args = {
                    "lm_configs": {"main_model": model},
                    "max_steps": max_steps
                }
                create_topic(name, args)
    
    # æ˜¾ç¤ºå·²æœ‰ä¸»é¢˜
    st.subheader("ç°æœ‰ä¸»é¢˜")
    topics = get_topics()
    for topic in topics:
        col1, col2 = st.columns([4,1])
        with col1:
            st.markdown(f"**{topic['name']}**")
            st.caption(f"æ¨¡å‹: {topic['args']['lm_configs']['main_model']}")
        with col2:
            if st.button("ğŸ—‘ï¸", key=f"del_{topic['id']}"):
                delete_topic(topic['id'])

def show_main_content():
    """ä¸»å†…å®¹åŒº"""
    st.header("åä½œç ”ç©¶ä¼šè¯")
    
    # ä¼šè¯é€‰æ‹©
    selected_topic = st.selectbox(
        "é€‰æ‹©ç ”ç©¶ä¸»é¢˜",
        get_topics(),
        format_func=lambda x: x['name']
    )
    
    if selected_topic:
        sessions = get_sessions(selected_topic['id'])
        if sessions:
            selected_session = st.selectbox(
                "é€‰æ‹©ä¼šè¯",
                sessions,
                format_func=lambda x: f"ä¼šè¯ {x['id']} - {x['created']}"
            )
            show_session_interface(selected_session)
        else:
            if st.button("æ–°å»ºä¼šè¯"):
                create_session(selected_topic['id'])
                st.rerun()

def show_session_interface(session):
    """æ˜¾ç¤ºä¼šè¯ç•Œé¢"""
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.subheader("ç ”ç©¶å¯¹è¯")
        show_chat_history(session['id'])
        
        user_input = st.text_input("è¾“å…¥ä½ çš„æƒ³æ³•æˆ–é—®é¢˜...")
        col1_1, col1_2 = st.columns([3, 1])
        with col1_1:
            if st.button("å‘é€æ¶ˆæ¯"):
                send_message(session['id'], user_input)
                st.rerun()
        with col1_2:
            if st.button("è‡ªåŠ¨æ¨è¿›"):
                auto_step(session['id'])
                st.rerun()
    
    with col2:
        st.subheader("ç ”ç©¶æŠ¥å‘Š")
        if st.button("ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š"):
            report = generate_report(session['id'])
            st.markdown(report['content'])
        
        st.subheader("çŸ¥è¯†å›¾è°±")
        # è¿™é‡Œå¯ä»¥æ·»åŠ çŸ¥è¯†å›¾è°±å¯è§†åŒ–ä»£ç 

def show_chat_history(session_id):
    """æ˜¾ç¤ºå¯¹è¯å†å²"""
    messages = get_messages(session_id)
    for msg in messages:
        with st.chat_message("user" if msg['role'] == 'user' else "assistant"):
            st.markdown(f"**{msg['role'].capitalize()}**: {msg['content']}")
            st.caption(msg['time'])

def handle_login(username, password):
    try:
        print("Sending login request...")
        response = requests.post(
            f"{BASE_API}/login",
            json={"username": username, "password": password}
        )
        if response.status_code == 200:
            st.session_state.token = response.json()['token']
            st.session_state.login_error = None
            st.rerun()
        else:
            st.session_state.login_error = response.json().get('message', 'æœªçŸ¥é”™è¯¯')
            st.error(f"ç™»å½•å¤±è´¥: {st.session_state.login_error}")
    except Exception as e:
        st.session_state.login_error = f"è¿æ¥æœåŠ¡å™¨å¤±è´¥: {str(e)}"
        st.error(f"ç™»å½•å¤±è´¥: {st.session_state.login_error}")

def handle_register(username, password):
    try:
        response = requests.post(
            f"{BASE_API}/register",
            json={"username": username, "password": password}
        )
        print("Line 188 response.status_code:",response.status_code)
        if response.status_code == 201:
            st.session_state.register_success = True
            st.session_state.active_tab = "login"
            st.rerun()
        else:
            st.session_state.register_error = response.json().get('message', 'æœªçŸ¥é”™è¯¯')
            st.error(f"æ³¨å†Œå¤±è´¥: {st.session_state.register_error}")
            # st.rerun()
    except Exception as e:
        st.session_state.register_error = f"è¿æ¥æœåŠ¡å™¨å¤±è´¥: {str(e)}"
        st.error(f"æ³¨å†Œå¤±è´¥: {st.session_state.register_error}")

def get_topics():
    headers = {"x-access-token": st.session_state.token}
    response = requests.get(f"{BASE_API}/topics", headers=headers)
    return response.json() if response.ok else []

def create_session(topic_id):
    headers = {"x-access-token": st.session_state.token}
    response = requests.post(
        f"{BASE_API}/sessions",
        json={"topic_id": topic_id},
        headers=headers
    )
    if response.status_code != 201:
        st.error("åˆ›å»ºä¼šè¯å¤±è´¥")

def auto_step(session_id):
    headers = {"x-access-token": st.session_state.token}
    response = requests.post(
        f"{BASE_API}/sessions/{session_id}/step",
        json={"observation": True},
        headers=headers
    )
    return response.json() if response.ok else None

if __name__ == "__main__":
    main()

# app.py
from flask import Flask, jsonify, request, make_response
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from werkzeug.security import generate_password_hash, check_password_hash
import jwt
import datetime
import uuid
import json
from functools import wraps
from flask_cors import CORS
from knowledge_storm.collaborative_storm.engine import (
    CollaborativeStormLMConfigs,
    CoStormRunner
)
from knowledge_storm.utils import load_api_key
import types

app = Flask(__name__)
CORS(app, supports_credentials=True)
app.config['SECRET_KEY'] = 'your-secret-key'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///knowledge_storm.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)
migrate = Migrate(app, db)

# æ•°æ®åº“æ¨¡å‹
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password = db.Column(db.String(120), nullable=False)
    topics = db.relationship('Topic', backref='user', lazy=True)

class Topic(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(120), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    sessions = db.relationship('Session', backref='topic', lazy=True)
    args = db.Column(db.Text)  # å­˜å‚¨åºåˆ—åŒ–çš„è¿è¡Œå‚æ•°

class Session(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    session_id = db.Column(db.String(36), unique=True, nullable=False)
    topic_id = db.Column(db.Integer, db.ForeignKey('topic.id'), nullable=False)
    runner_state = db.Column(db.Text)  # å­˜å‚¨åºåˆ—åŒ–çš„CoStormRunnerçŠ¶æ€
    messages = db.relationship('Message', backref='session', lazy=True)
    reports = db.relationship('Report', backref='session', lazy=True)

class Message(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.Text, nullable=False)
    role = db.Column(db.String(20), nullable=False)
    msg_type = db.Column(db.String(20), nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    session_id = db.Column(db.Integer, db.ForeignKey('session.id'), nullable=False)

class Report(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    content = db.Column(db.Text)
    created_at = db.Column(db.DateTime, default=datetime.datetime.utcnow)
    session_id = db.Column(db.Integer, db.ForeignKey('session.id'), nullable=False)

# è¾…åŠ©å‡½æ•°
def token_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        token = request.headers.get('x-access-token')
        if not token:
            return jsonify({'message': 'Token is missing!'}), 401
        try:
            data = jwt.decode(token, app.config['SECRET_KEY'], algorithms=["HS256"])
            current_user = User.query.get(data['user_id'])
        except:
            return jsonify({'message': 'Token is invalid!'}), 401
        return f(current_user, *args, **kwargs)
    return decorated

def initialize_runner(args_dict, topic_name):
    """åˆå§‹åŒ–çŸ¥è¯†é£æš´è¿è¡Œå™¨"""
    load_api_key(toml_file_path='.config/secrets.toml')
    lm_config = CollaborativeStormLMConfigs()
    
    # è½¬æ¢å‚æ•°
    args = types.SimpleNamespace(**args_dict)
    args.lm_configs = lm_config
    args.topic = topic_name
    
    runner = CoStormRunner(args)
    return runner

@app.route('/api/me', methods=['GET'])
@token_required
def get_current_user_endpoint(current_user):
    return jsonify({
        'user_id': current_user.id,
        'username': current_user.username#,
        # 'created_at': current_user.date_created.isoformat()
    })

# ç”¨æˆ·è®¤è¯API
@app.route('/api/register', methods=['POST'])
def register():
    data = request.json
    if User.query.filter_by(username=data['username']).first():
        return jsonify({'message': 'Username already exists!'}), 409
        
    hashed_password = generate_password_hash(data['password'])
    new_user = User(username=data['username'], password=hashed_password)
    db.session.add(new_user)
    db.session.commit()
    return jsonify({'message': 'Registered successfully!'}), 201

@app.route('/api/login', methods=['POST'])
def login():
    data = request.json
    user = User.query.filter_by(username=data['username']).first()
    if not user or not check_password_hash(user.password, data['password']):
        return jsonify({'message': 'Invalid credentials!'}), 401
        
    token = jwt.encode({
        'user_id': user.id,
        'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)
    }, app.config['SECRET_KEY'])
    
    return jsonify({'token': token})

# ä¸»é¢˜ç®¡ç†API
@app.route('/api/topics', methods=['POST'])
@token_required
def create_topic(current_user):
    data = request.json
    new_topic = Topic(
        name=data['name'],
        user_id=current_user.id,
        args=json.dumps(data.get('args', {})))
    db.session.add(new_topic)
    db.session.commit()
    return jsonify({'message': 'Topic created', 'id': new_topic.id}), 201

@app.route('/api/topics', methods=['GET'])
@token_required
def get_topics(current_user):
    topics = Topic.query.filter_by(user_id=current_user.id).all()
    return jsonify([{
        'id': t.id,
        'name': t.name,
        'args': json.loads(t.args)
    } for t in topics])

# ä¼šè¯ç®¡ç†API
@app.route('/api/sessions', methods=['POST'])
@token_required
def create_session(current_user):
    data = request.json
    topic = Topic.query.filter_by(id=data['topic_id'], user_id=current_user.id).first()
    if not topic:
        return jsonify({'error': 'Topic not found'}), 404
    
    # åˆå§‹åŒ–çŸ¥è¯†é£æš´è¿è¡Œå™¨
    args_dict = json.loads(topic.args)
    runner = initialize_runner(args_dict, topic.name)
    
    # åˆ›å»ºæ–°ä¼šè¯
    new_session = Session(
        session_id=str(uuid.uuid4()),
        topic_id=topic.id,
        runner_state=json.dumps(runner.to_dict())
    )
    db.session.add(new_session)
    
    # ä¿å­˜åˆå§‹æ¶ˆæ¯
    init_message = Message(
        content=f"New session started for topic: {topic.name}",
        role="system",
        msg_type="notification",
        session=new_session
    )
    db.session.add(init_message)
    db.session.commit()
    
    return jsonify({
        'session_id': new_session.session_id,
        'topic_id': topic.id
    }), 201

# æ¶ˆæ¯å¤„ç†API
@app.route('/api/sessions/<session_id>/step', methods=['POST'])
@token_required
def process_step(current_user, session_id):
    session = Session.query.filter_by(session_id=session_id).first()
    if not session or session.topic.user_id != current_user.id:
        return jsonify({'error': 'Session not found'}), 404
    
    # åŠ è½½è¿è¡Œå™¨çŠ¶æ€
    runner = CoStormRunner.from_dict(json.loads(session.runner_state))
    
    # å¤„ç†ç”¨æˆ·è¾“å…¥
    data = request.json
    user_input = data.get('input', '')
    observation_mode = data.get('observation', False)
    
    if user_input:
        # ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
        user_msg = Message(
            content=user_input,
            role="user",
            msg_type="text",
            session=session
        )
        db.session.add(user_msg)
        runner.step(user_utterance=user_input)
    
    # æ‰§è¡Œä¸‹ä¸€æ­¥
    if observation_mode:
        conv_turn = runner.step(observation_mode=True)
    else:
        conv_turn = runner.step()
    
    # ä¿å­˜ç³»ç»Ÿæ¶ˆæ¯
    system_msg = Message(
        content=conv_turn.utterance,
        role=conv_turn.role,
        msg_type="text",
        session=session
    )
    db.session.add(system_msg)
    
    # æ›´æ–°è¿è¡Œå™¨çŠ¶æ€
    session.runner_state = json.dumps(runner.to_dict())
    db.session.commit()
    
    return jsonify({
        'response': conv_turn.utterance,
        'role': conv_turn.role
    })

# æŠ¥å‘Šç”ŸæˆAPI
@app.route('/api/sessions/<session_id>/report', methods=['POST'])
@token_required
def generate_report(current_user, session_id):
    session = Session.query.filter_by(session_id=session_id).first()
    if not session or session.topic.user_id != current_user.id:
        return jsonify({'error': 'Session not found'}), 404
    
    # åŠ è½½è¿è¡Œå™¨çŠ¶æ€
    runner = CoStormRunner.from_dict(json.loads(session.runner_state))
    
    # ç”ŸæˆæŠ¥å‘Š
    runner.knowledge_base.reorganize()
    report_content = runner.generate_report()
    
    # ä¿å­˜æŠ¥å‘Š
    new_report = Report(
        content=report_content,
        session=session
    )
    db.session.add(new_report)
    db.session.commit()
    
    return jsonify({
        'report_id': new_report.id,
        'content': report_content
    })

if __name__ == '__main__':
    app.run(port=5000)#,debug=True)